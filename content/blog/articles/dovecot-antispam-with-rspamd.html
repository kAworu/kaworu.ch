---
kind: article
navbar: Blog
title: "Dovecot antispam with Rspamd"
created_at: 2014-03-25 20:00:47 +0100
updated_at: 2015-05-15 10:46:59 +0200
comments: true
tags: [sysadmin]
---

<div class="clearfix">
    <img class="no-border left" src="<%= static_url '/images/mail.png' %>" alt="email">

    <p>
        I am using <a href="https://rspamd.com/">Rspamd</a> since a while now and I
        happy with it. In a nutshell <span class="brand">Rspamd</span> is a
        fast, free and extensible spam filtering system.

    <p>
        To be honest I am not a guru when it comes to mail server configuration.
        Every time I'm hacking something in the mail territory I have to look up
        what is a MTA, MDA etc. Unlike spamassasin,
        <span class="brand">Rspamd</span> was simple to setup and has sane
        defaults so I adopted it merrily. As a bonus, it has a sexy Web UI.

    <p>
        In this post I'll provide my configuration for a nice integration with
        the <a href="http://wiki2.dovecot.org/Plugins/Antispam">dovecot antispam plugin</a>.
</div>

<!-- more -->

<p class="alert alert-warning">
    If you're planning to use <span class="brand">Rspamd</span> under FreeBSD
    be sure to  check the main
    <a href="https://rspamd.com/blog/">website news</a> before upgrades. In my
    experience there has been configuration breaks that were not advertised in
    UPDATING as one would expect.

```{"title":"90-plugin.conf"}
plugin {
    antispam_backend = mailtrain
    antispam_spam    = Junk
    antispam_trash   = Trash
    antispam_mail_sendmail = /usr/local/bin/rspamc
    antispam_mail_spam     = learn_spam
    antispam_mail_notspam  = learn_ham
    antispam_mail_sendmail_args = -h;localhost:11334;-P;q1
}
```

<p>What this configuration does is: </p>

<ul>
    <li>
        When a mail is moved from any IMAP directory (except <code>Trash</code>
        and <code>Junk</code>) to the <code>Junk</code> directory, the
        following command will be issued:
```{"linenos":false}
% /usr/local/bin/rspamc -h localhost:11334 -P q1 learn_spam < mail
```
    <li>
        When a mail is moved from the <code>Junk</code> directory to any IMAP
        directory (except <code>Trash</code> and <code>Junk</code>) the
        following command will be issued:
```{"linenos":false}
% /usr/local/bin/rspamc -h localhost:11334 -P q1 learn_ham < mail
```
</ul>

<p>
    So every time a user gets a spam into its <code>Inbox</code>, moving it
    into <code>Junk</code> will make <span class="brand">rspamd</span> learn it
    as spam (and hopefully filter it better the next time).  Every time someone
    gets a desired email into <code>Junk</code>, moving it into its
    <code>Inbox</code> (or else) will make rspamd learn it as ham.

<p>
    This is not perfect for all needs though. As you can see I use a
    system-wide spam/ham database, so choices from one user does effectively
    affect how rspamd filter mail for every users.


<h2>Notes</h2>

<p>
    Be sure to adapt the rspamd password to the one you've choosen while
    configuring rspamd. I've left the default password <code>q1</code> in this
    example. Also check where <span class="manpage">rspamc(1)</span> is
    installed (in my case it is <span class="path">/usr/local/bin</span>).

<p>
    If you need to hack this configuration be careful with the
    <code>antispam_mail_sendmail_args</code>: it uses the </code>;</code>
    separator for arguments. I remember having a lot of troubles while
    debugging because of that.

<p>
    That's it! If you need help or want to know more about rspamd, check
    <a href="https://rspamd.com/">the website</a> or join <kbd>#rspamd</kbd> on
    freenode :D
